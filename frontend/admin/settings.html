<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SIT Admin – Settings</title>
  <link rel="stylesheet" href="assets/css/style.css" />
</head>
<body>
  <!-- Top Bar -->
  <div class="topbar">
    <button class="topbar-close" title="Close" onclick="window.close()">&#10005;</button>
    <div class="topbar-search">
      <span class="search-icon">&#128269;</span>
      <input type="text" placeholder="Search... (Ctrl+K)" id="globalSearch" onfocus="document.dispatchEvent(new KeyboardEvent('keydown',{key:'k',ctrlKey:true}))" readonly />
    </div>
    <div class="topbar-right">
      <button class="notif-bell" id="notifBell" onclick="toggleNotifDropdown()">
        &#128276;<span class="notif-badge" id="notifCount" style="display:none">0</span>
      </button>
      <div class="user-pill" id="userPill">
        <div class="user-avatar" id="userAvatar">A</div>
        <div class="user-pill-info">
          <div class="name" id="userName">Admin</div>
          <div class="email" id="userEmail">admin@example.com</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Dropdown -->
  <div class="notif-dropdown" id="notifDropdown">
    <div class="notif-dropdown-header">
      <h3>Notifications</h3>
      <button class="btn btn-sm" onclick="markAllNotifRead()">Mark all read</button>
    </div>
    <div class="notif-dropdown-body" id="notifList"></div>
    <div class="notif-dropdown-footer">
      <button class="btn btn-sm" onclick="toggleNotifDropdown()">Close</button>
    </div>
  </div>

  <div class="layout">
    <nav class="sidebar">
      <div class="brand">ADMIN PANEL</div>
      <div class="brand-sub">Enterprise Dashboard</div>
      <a href="dashboard.html"><span class="nav-icon">&#9632;</span><span>Dashboard</span></a>
      <a href="scans.html"><span class="nav-icon">&#128269;</span><span>Scans</span></a>
      <a href="users.html"><span class="nav-icon">&#128101;</span><span>Users</span></a>
      <a href="reports.html"><span class="nav-icon">&#128196;</span><span>Reports</span></a>
      <a href="analytics.html"><span class="nav-icon">&#128200;</span><span>Analytics</span></a>
      <a href="settings.html" class="active"><span class="nav-icon">&#9881;</span><span>Settings</span></a>
      <div class="spacer"></div>
      <a href="#" class="logout-btn" onclick="logout()"><span class="nav-icon">&#10140;</span><span>Logout</span></a>
    </nav>

    <div class="main">
      <h1>Settings</h1>
      <div class="live-status" id="liveStatus">Loading settings...</div>

      <!-- General Settings -->
      <div class="card">
        <div class="settings-section">
          <h3>General Settings</h3>
          <div class="form-group">
            <label>System Name</label>
            <input type="text" id="settSystemName" placeholder="SIT Admin Panel" />
          </div>
          <div class="form-group">
            <label>Time Zone</label>
            <select id="settTimezone">
              <option value="Asia/Kuala_Lumpur">Asia/Kuala_Lumpur (UTC+8)</option>
              <option value="Asia/Singapore">Asia/Singapore (UTC+8)</option>
            </select>
            <div style="margin-top:6px;font-size:12px;color:var(--text-3)">
              Current Time (Preview):
              <span id="tzClock" style="font-weight:600;color:var(--text-1)">--:--:--</span>
            </div>
          </div>
          <div class="settings-row" style="margin-top:10px">
            <div>
              <div class="sr-label">Session Timeout</div>
              <div class="sr-desc">Minutes of inactivity before auto-logout</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="settSessionTimeout" value="480" min="5" max="1440" style="width:80px;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px" />
              <span style="font-size:11px;color:var(--text-3)">min</span>
            </div>
          </div>
          <div class="settings-row" style="margin-top:10px">
            <div>
              <div class="sr-label">2FA Status</div>
              <div class="sr-desc">Read-only indicator from backend</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="sett2FAEnabled" disabled />
              <span class="slider"></span>
            </label>
          </div>
          <div class="settings-row" style="margin-top:10px">
            <div>
              <div class="sr-label">Automatic Backup</div>
              <div class="sr-desc">High-level status from settings</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="settAutoBackupEnabled" disabled />
              <span class="slider"></span>
            </label>
          </div>
          <div class="form-group" style="margin-top:12px">
            <label>Last Backup (from settings)</label>
            <div id="settLastBackupSummary" style="font-size:12px;color:var(--text-3)">Never</div>
          </div>
          <button class="btn btn-primary" id="btnSaveGeneral" onclick="saveGeneralSettings()">Save General Settings</button>
        </div>
      </div>

      <!-- Security Settings -->
      <div class="card">
        <div class="settings-section">
          <h3>Security Settings</h3>

          <div class="form-group">
            <label>Change Password</label>
            <input type="password" id="settCurrentPw" placeholder="Current password" style="margin-bottom:6px" />
            <input type="password" id="settNewPw" placeholder="New password" style="margin-bottom:6px" />
            <input type="password" id="settConfirmPw" placeholder="Confirm new password" />
          </div>
          <button class="btn" onclick="changePassword()" style="margin-bottom:18px">Change Password</button>

          <div class="settings-row">
            <div>
              <div class="sr-label">Enable 2FA (TOTP)</div>
              <div class="sr-desc">Require authenticator app code on login</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="toggle2FA" onchange="handle2FAToggle(this)" />
              <span class="slider"></span>
            </label>
          </div>

          <div id="twofaSetupPanel" style="display:none;margin-top:14px;padding:14px;border:1px solid var(--border);border-radius:var(--radius)">
            <p style="font-size:13px;margin-bottom:8px;font-weight:600">2FA Setup</p>
            <p style="font-size:12px;color:var(--text-3);margin-bottom:8px">Add this secret to your authenticator app, then enter the 6-digit code to confirm.</p>
            <div style="background:#f9fafb;padding:10px;border-radius:4px;font-family:monospace;font-size:14px;margin-bottom:10px;word-break:break-all" id="twofaSecret">-</div>
            <div class="form-group" style="margin-bottom:8px">
              <label>Verification Code</label>
              <input type="text" id="twofaConfirmCode" placeholder="000000" maxlength="6" style="max-width:200px" />
            </div>
            <button class="btn btn-primary btn-sm" onclick="confirm2FA()">Confirm 2FA</button>
          </div>

          <div class="settings-row" style="margin-top:10px">
            <div>
              <div class="sr-label">Session Timeout</div>
              <div class="sr-desc">Minutes of inactivity before auto-logout</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px">
              <input type="number" id="settSessionTimeoutSecurity" value="480" min="5" max="1440" style="width:80px;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px" />
              <span style="font-size:11px;color:var(--text-3)">min</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Backup Settings -->
      <div class="card">
        <div class="settings-section">
          <h3>Backup Settings</h3>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
            <div>
              <div style="font-size:13px;font-weight:500">Last backup</div>
              <div style="font-size:12px;color:var(--text-3)" id="lastBackupTime">Never</div>
            </div>
            <button class="btn btn-primary btn-sm" onclick="runManualBackup()">Manual Backup Now</button>
          </div>
          <div class="form-group" style="margin-bottom:10px">
            <label>Backup History (last 5)</label>
            <div id="backupHistory" style="font-size:12px;color:var(--text-3)">Loading...</div>
          </div>
          <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
            <button class="btn btn-sm" id="btnDownloadBackup" onclick="downloadLatestBackup()">Download latest backup</button>
            <button class="btn btn-sm" id="btnRestoreBackup" onclick="openRestoreModal()">Restore from backup</button>
          </div>
          <div class="settings-row">
            <div>
              <div class="sr-label">Automatic Backup</div>
              <div class="sr-desc" id="backupScheduleText">Daily 3:00 AM</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="toggleAutoBackup" onchange="saveAutoBackup(this)" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="form-group" style="margin-top:10px">
            <label>Backup Time of Day</label>
            <input type="time" id="backupTime" value="03:00" style="max-width:140px" />
          </div>
          <div class="form-group">
            <label>Retention</label>
            <select id="backupRetention" style="max-width:140px">
              <option value="7">7 days</option>
              <option value="30">30 days</option>
              <option value="90">90 days</option>
            </select>
          </div>
          <div class="form-group">
            <label>Next Scheduled Backup</label>
            <div id="nextBackupInfo" style="font-size:12px;color:var(--text-3)">--</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Restore backup modal -->
  <div id="restoreBackupModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header"><h3>Restore from backup</h3><button type="button" class="modal-close" onclick="closeRestoreModal()">&#10005;</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label>Backup</label>
          <select id="restoreBackupId" style="width:100%">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Mode</label>
          <select id="restoreMode" style="width:100%">
            <option value="safe">SAFE – system settings only</option>
            <option value="full">FULL – settings + users + reports + audit logs</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type <strong>RESTORE</strong> to confirm</label>
          <input type="text" id="restoreConfirm" placeholder="RESTORE" style="width:100%" />
        </div>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn btn-primary" id="btnRestoreSubmit" onclick="submitRestore()">Restore</button>
          <button class="btn" onclick="closeRestoreModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/api.js"></script>
  <script src="assets/js/settings.js"></script>
</body>
</html>
